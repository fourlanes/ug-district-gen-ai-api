# Natural Language Query API - Feature Specification

## Overview
A Cloudflare Workers-based serverless API that processes natural language queries about Uganda district data using OpenAI's GPT models. The API interprets user questions, analyzes relevant CSV data, and returns structured responses that the dashboard can display or use to apply filters.

## Architecture

### Components
1. **Cloudflare Worker** - Serverless function handling query requests
2. **OpenAI API** - Natural language processing and intent interpretation
3. **Data Layer** - CSV files stored with worker for query processing
4. **Response Handler** - Structures API responses for dashboard consumption

### Request Flow
```
Dashboard (QueryInterface)
    ↓ POST /query
Cloudflare Worker
    ↓ Load relevant CSV data
    ↓ Build context prompt
OpenAI API (GPT-4o-mini)
    ↓ Interpret query + analyze data
    ↓ Return structured response
Cloudflare Worker
    ↓ Format response
Dashboard (Display/Apply)
```

## API Specification

### Endpoint
**POST** `/query`

### Request Body
```json
{
  "query": "Which subcounty needs more teachers?",
  "location": {
    "district": "kayunga",
    "subcounty": null,
    "parish": null,
    "village": null
  },
  "category": "education"
}
```

### Response Types

#### Type 1: Direct Answer
```json
{
  "type": "answer",
  "text": "Busaana subcounty has the highest pupil-teacher ratio at 52:1, exceeding the WHO recommendation of 40:1 for primary schools.",
  "data": {
    "location": "Busaana",
    "metric": "pupil_teacher_ratio",
    "value": 52,
    "benchmark": 40,
    "severity": "high"
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### Type 2: Filtered Results
```json
{
  "type": "filter",
  "text": "Found 8 schools without electricity in Kayunga District",
  "filters": {
    "electricity_available": "No"
  },
  "resultCount": 8,
  "facilities": [
    {
      "name": "School A",
      "location": "Subcounty X",
      "additional_gaps": ["water", "ict_lab"]
    }
  ],
  "suggestedView": "grid",
  "suggestedAction": "View these schools on the map to plan electrification rollout",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### Type 3: Comparison/Ranking
```json
{
  "type": "comparison",
  "text": "Subcounty teacher distribution (highest to lowest):",
  "rankings": [
    {"location": "Kangulumira", "value": 45, "metric": "total_teachers"},
    {"location": "Kayunga", "value": 38, "metric": "total_teachers"},
    {"location": "Busaana", "value": 32, "metric": "total_teachers"}
  ],
  "suggestedView": "comparison",
  "insights": "Kangulumira has 40% more teachers than Busaana despite similar student populations",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### Type 4: Error/Clarification
```json
{
  "type": "clarification",
  "text": "I need more context. Are you asking about health or education facilities?",
  "suggestions": [
    "Which subcounty has the fewest health facilities?",
    "Show me schools with poor infrastructure",
    "Compare teacher ratios across subcounties"
  ],
  "timestamp": "2024-01-15T10:30:00Z"
}
```

## Data Processing Strategy

### Data Loading
```javascript
// Load only relevant CSV based on location and category
async function loadRelevantData(location, category) {
  if (category === 'health') {
    return await loadCSV(`data/facilities/${location.district}_health_facilities.csv`);
  } else if (category === 'education') {
    return await loadCSV(`data/facilities/${location.district}_education_facilities.csv`);
  }
  // Include trends data if time-based query detected
}
```

### Context Building
For each query, build a focused data context:
```javascript
const context = {
  location: location.district,
  category: category,
  aggregatedMetrics: calculateMetrics(facilities, location),
  availableFilters: getAvailableFilters(category),
  benchmarks: getBenchmarks(category) // WHO recommendations, etc.
};
```

### Metric Calculations
Pre-calculate common metrics to include in AI context:
- Service coverage percentages
- Infrastructure availability rates
- Average ratios (pupil-teacher, pupil-classroom, etc.)
- Facility counts by type/level
- Comparison to benchmarks

## OpenAI Integration

### Model Selection
- **Primary:** `gpt-4o-mini` (cost-effective, sufficient for this use case)
- **Fallback:** `gpt-3.5-turbo` if budget concerns

### Prompt Structure

**System Prompt:**
```
You are a data analyst helping Ugandan district officials understand their local data. 

Your role:
- Interpret natural language questions about health and education facilities
- Analyze provided data to answer questions accurately
- Return responses in a structured JSON format
- Be specific with numbers and locations
- Suggest actionable insights when relevant
- Use simple language appropriate for non-technical users

Available data context:
- Location hierarchy: Districts > Subcounties > Parishes > Villages
- Categories: Health facilities, Education facilities, Trends data
- Metrics vary by category (see data schema)

Response guidelines:
- Always cite specific numbers from the data
- Compare to benchmarks when available (WHO recommendations, national averages)
- Suggest which dashboard view would best display the information
- If query is ambiguous, ask for clarification
- Never make up data - only use what's provided
```

**User Prompt Template:**
```
Query: "{user_query}"

Current Context:
- Location: {location.district} {location.subcounty ? `> ${location.subcounty}` : ''}
- Category: {category}

Available Data:
{JSON.stringify(aggregatedMetrics, null, 2)}

Data Schema:
{JSON.stringify(dataSchema, null, 2)}

Interpret this query and return a JSON response with:
1. type: "answer" | "filter" | "comparison" | "clarification"
2. text: Plain language response
3. data/filters/rankings: Relevant structured data
4. suggestedView: Which dashboard view to show (map/grid/charts/comparison)
5. suggestedAction: Optional action user should take

Return only valid JSON, no additional text.
```

## Error Handling

### Rate Limiting
- Track requests per IP
- Limit: 20 queries per minute per IP
- Return 429 Too Many Requests if exceeded

### Query Validation
```javascript
function validateQuery(request) {
  if (!request.query || request.query.length < 3) {
    return { valid: false, error: "Query too short" };
  }
  if (request.query.length > 500) {
    return { valid: false, error: "Query too long" };
  }
  if (!request.category || !['health', 'education'].includes(request.category)) {
    return { valid: false, error: "Invalid category" };
  }
  return { valid: true };
}
```

### OpenAI Failures
- Timeout: 30 seconds max
- Retry: 1 automatic retry on failure
- Fallback: Return clarification response asking user to rephrase

### Data Issues
- Missing CSV: Return error explaining data unavailable for that location
- Parsing errors: Log error, return generic error to user

## CORS Configuration

```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': 'https://your-dashboard-domain.com',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type',
  'Access-Control-Max-Age': '86400',
};

// Handle preflight
if (request.method === 'OPTIONS') {
  return new Response(null, { headers: corsHeaders });
}
```

## Performance Optimization

### Caching Strategy
```javascript
// Cache common queries for 1 hour
const cache = await caches.default;
const cacheKey = new Request(
  `https://cache/${category}/${location.district}/${hashQuery(query)}`
);

const cachedResponse = await cache.match(cacheKey);
if (cachedResponse) return cachedResponse;

// Process query, then cache
const response = await processQuery(...);
await cache.put(cacheKey, response.clone());
return response;
```

### Data Loading
- Only load CSVs for requested location/category
- Keep parsed data in memory during worker execution
- Use streaming for large files

## Cost Management

### Usage Tracking
```javascript
// Log each request for monitoring
console.log({
  timestamp: Date.now(),
  category: request.category,
  location: request.location.district,
  queryLength: request.query.length,
  cached: wasCached,
  tokensUsed: response.tokensUsed
});
```

### Budget Safeguards
- Set OpenAI API key with usage limits
- Monitor via Cloudflare Workers dashboard
- Alert if approaching free tier limits

### Expected Costs
- Cloudflare Workers: FREE (under 100K requests/day)
- OpenAI API: ~$0.0004 per query
- Monthly estimate (2,500 queries): ~$1.00

## Security

### API Key Protection
- Store as Cloudflare Worker secret
- Never expose in responses or logs
- Rotate periodically

### Input Sanitization
- Validate all input fields
- Strip potentially harmful content
- Limit query length

### Rate Limiting
- Per-IP limits to prevent abuse
- Monitor for unusual patterns
- Block persistent abusers

## Monitoring & Analytics

### Track Metrics
- Queries per day/week
- Response types distribution
- Average response time
- Cache hit rate
- Error rate
- Most common queries

### Logging
```javascript
{
  timestamp: ISO-8601,
  query: hashed_query,
  category: category,
  location: location,
  responseType: type,
  cached: boolean,
  duration_ms: number,
  tokensUsed: number,
  error: null | error_message
}
```

## Development Workflow

### Local Testing
```bash
# Start local worker
wrangler dev

# Test with curl
curl -X POST http://localhost:8787/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Which subcounty needs more teachers?",
    "location": {"district": "kayunga"},
    "category": "education"
  }'
```

### Deployment
```bash
# Deploy to Cloudflare
wrangler deploy

# Tail logs in production
wrangler tail
```

### Staging Environment
- Use separate worker for testing (`uganda-data-query-api-staging`)
- Test with real data before production deployment

## Integration with Dashboard

### QueryInterface Component Changes
Replace mock handler with real API calls:

```javascript
async function processQuery(query, location, category) {
  const response = await fetch('https://uganda-data-query-api.YOUR-SUBDOMAIN.workers.dev/query', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, location, category })
  });
  
  if (!response.ok) {
    throw new Error('Query failed');
  }
  
  return await response.json();
}
```

### Action Handling
Based on response type, dashboard should:
- **answer:** Display text response
- **filter:** Apply filters and optionally switch to suggested view
- **comparison:** Switch to comparison view with highlighted data
- **clarification:** Show suggestions for better queries

## Success Metrics

### Technical
- Response time < 3 seconds (95th percentile)
- Error rate < 2%
- Cache hit rate > 40%
- Uptime > 99.5%

### User Experience
- Query success rate > 80% (not requiring clarification)
- User satisfaction > 4/5
- Repeat query usage > 30% of users

## Future Enhancements

### Phase 2.1 (Optional)
- Multi-turn conversations (query history context)
- Voice input support
- Visualizations generated from queries
- Export query results

### Phase 2.2 (Optional)
- Predictive suggestions while typing
- Popular queries dashboard
- Query analytics for insights
- Multi-language support (Luganda, etc.)

---
